#!/usr/bin/env python
#coding=utf-8
#import sys
#default_encoding = 'utf-8'
#if sys.getdefaultencoding() != default_encoding:
# reload(sys)
# sys.setdefaultencoding(default_encoding)
#    __author__ = '于明义'
#    __date__ = '2018/5/8'
#    __Desc__ = 从数据库中导出数据到excel数据表中
import sys
import xlrd
import xlwt
import pyodbc
import time
import datetime
import os
import pandas as pd
import numpy as np
import re
Dir_file = u'E:\\电话统计\\一遍'
Excel_file = Dir_file + os.sep + u'数据源'  + os.sep + os.listdir(Dir_file + os.sep + u'数据源')[0]
start_time = datetime.datetime.now()
# Open the workbook and define the worksheet
book = xlrd.open_workbook(Excel_file)
sheet = book.sheet_by_name("Sheet1")
#建立一个MySQL连接
print('连接数据库中,请稍等')
database = pyodbc.connect(r'DRIVER={SQL Server Native Client 11.0};SERVER=HY-201708281139\YUMINGYI;DATABASE=datasource1;UID=sa;PWD=19911202441x')
print('数据库连接成功!')
# 获得游标对象, 用于逐行遍历数据库数据
cursor = database.cursor()
cursor.execute("if exists(select * from dbo.sysobjects where name='sheet1')  drop table sheet1  ")
print ('数据存储中,请稍等')
create = """CREATE TABLE sheet1 (
            婚博会id VARCHAR(255) NOT NULL,
            一次电话内容 VARCHAR(255),
            一次电话负责人 VARCHAR(255),
            一次电话判定 VARCHAR(255), 
            一次电话分配日期 VARCHAR(255))"""
cursor.execute(create)
# 创建插入SQL语句

insert = """INSERT INTO sheet1 (婚博会id, 一次电话内容, 一次电话负责人, 一次电话判定, 一次电话分配日期) VALUES (?, ?, ?, ?, ?)"""

# 创建一个for循环迭代读取xls文件每行数据的, 从第二行开始是要跳过标题
for r in range(1, sheet.nrows):
      婚博会id =sheet.cell(r,12).value
      一次电话内容 =sheet.cell(r,93).value
      一次电话负责人 =sheet.cell(r,94).value
      一次电话判定 =sheet.cell(r,95).value
      一次电话分配日期 =sheet.cell(r,96).value
      values = (婚博会id, 一次电话内容, 一次电话负责人, 一次电话判定, 一次电话分配日期 )
      # 执行sql语句
      cursor.execute(insert,values)
columns = str(sheet.ncols)
rows = str(sheet.nrows-1)
print ("数据存储成功,共",rows,"行",columns,"列数据!")
query="""select 一次电话分配日期,一次电话内容,一次电话负责人,

sum(case  when 一次电话判定 is not null then 1 end) as  '分配总量',

sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','双空错号','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票','三天未通'
) then 1 end) as  '打通',

sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票'
) then 1 end) as  '通话',

CAST(CONVERT( DECIMAL(18,2),sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','双空错号','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票','三天未通'
) then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 is not null then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '打通率',

CAST(CONVERT( DECIMAL(18,2),sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票'
) then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','双空错号','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票','三天未通'
) then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '通话率',

sum(case  when 一次电话判定 in('婚博会-来','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-现场取','旅游展-来','旅游展-现场取','家博会-来','家博会-现场取','家博会-扫码入场') then 1 end) as  '总来',
CAST(CONVERT( DECIMAL(18,2),sum(case  when 一次电话判定 in('婚博会-来','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-现场取','旅游展-来','旅游展-现场取','家博会-来','家博会-现场取','家博会-扫码入场') then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票'
) then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '总来率',

sum(case  when 一次电话判定 in('婚博会-不确定','婚博会-判断不清','珠宝展-不确定','珠宝展-判断不清','旅游展-不确定','旅游展-判断不清','家博会-不确定','家博会-判断不清','快递前确认地址') then 1 end) as  '总不确定',
CAST(CONVERT( DECIMAL(18,2),sum(case  when 一次电话判定 in('婚博会-不确定','婚博会-判断不清','珠宝展-不确定','珠宝展-判断不清','旅游展-不确定','旅游展-判断不清','家博会-不确定','家博会-判断不清','快递前确认地址') then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票'
) then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '总不确定率',


sum(case  when 一次电话判定 in('婚博会-来','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-现场取','旅游展-来','旅游展-现场取','家博会-来','家博会-现场取','家博会-扫码入场','婚博会-不确定','婚博会-判断不清','珠宝展-不确定','珠宝展-判断不清','旅游展-不确定','旅游展-判断不清','家博会-不确定','家博会-判断不清','快递前确认地址' ) then 1 end) as  '总有效',
CAST(CONVERT( DECIMAL(18,2),sum(case  when 一次电话判定 in('婚博会-来','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-现场取','旅游展-来','旅游展-现场取','家博会-来','家博会-现场取','家博会-扫码入场','婚博会-不确定','婚博会-判断不清','珠宝展-不确定','珠宝展-判断不清','旅游展-不确定','旅游展-判断不清','家博会-不确定','家博会-判断不清','快递前确认地址') then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票'
) then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '总有效率',

sum(case  when 一次电话判定 in('不来','下届联系') then 1 end) as  '不来+下届联系',
CAST(CONVERT( DECIMAL(18,2),sum(case  when 一次电话判定 in('不来','下届联系') then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票'
) then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '不来+下届联系率',

sum(case 一次电话判定 when '婚博会-来' then 1 end) as  '婚博会-来',
sum(case 一次电话判定 when '婚博会-不确定' then 1 end) as  '婚博会-不确定',
sum(case 一次电话判定 when '婚博会-判断不清' then 1 end) as  '婚博会-判断不清',
sum(case 一次电话判定 when '婚博会-扫码入场' then 1 end) as  '婚博会-扫码入场',
sum(case 一次电话判定 when '婚博会-已经有票' then 1 end) as  '婚博会-已经有票',
sum(case 一次电话判定 when '珠宝展-来' then 1 end) as  '珠宝展-来',
sum(case 一次电话判定 when '珠宝展-不确定' then 1 end) as  '珠宝展-不确定',
sum(case 一次电话判定 when '珠宝展-现场取' then 1 end) as  '珠宝展-现场取',
sum(case 一次电话判定 when '珠宝展-判断不清' then 1 end) as  '珠宝展-判断不清',
sum(case 一次电话判定 when '旅游展-来' then 1 end) as  '旅游展-来',
sum(case 一次电话判定 when '旅游展-不确定' then 1 end) as  '旅游展-不确定',
sum(case 一次电话判定 when '旅游展-现场取' then 1 end) as  '旅游展-现场取',
sum(case 一次电话判定 when '旅游展-判断不清' then 1 end) as  '旅游展-判断不清',
sum(case 一次电话判定 when '家博会-来' then 1 end) as  '家博会-来',
sum(case 一次电话判定 when '家博会-不确定' then 1 end) as  '家博会-不确定',
sum(case 一次电话判定 when '家博会-判断不清' then 1 end) as  '家博会-判断不清',
sum(case 一次电话判定 when '家博会-现场取' then 1 end) as  '家博会-现场取',
sum(case 一次电话判定 when '家博会-扫码入场' then 1 end) as  '家博会-扫码入场',
sum(case 一次电话判定 when '快递前确认地址' then 1 end) as  '快递前确认地址',
sum(case 一次电话判定 when '双空错号' then 1 end) as  '双空错号',
sum(case 一次电话判定 when '不来' then 1 end) as  '不来',
sum(case 一次电话判定 when '下届联系' then 1 end) as  '下届联系',
sum(case 一次电话判定 when '下届无效' then 1 end) as  '下届无效',
sum(case 一次电话判定 when '暂无需求' then 1 end) as  '暂无需求',
sum(case 一次电话判定 when '筹备完毕' then 1 end) as  '筹备完毕',
sum(case 一次电话判定 when '勿扰' then 1 end) as  '勿扰',
sum(case 一次电话判定 when '小蜜蜂专业' then 1 end) as  '小蜜蜂专业',
sum(case 一次电话判定 when '重复数据' then 1 end) as  '重复数据',
sum(case 一次电话判定 when '删除数据' then 1 end) as  '删除数据',
sum(case 一次电话判定 when '异地索票' then 1 end) as  '异地索票',
sum(case 一次电话判定 when '展前联系' then 1 end) as  '展前联系',
sum(case 一次电话判定 when '家博会-展前联系' then 1 end) as  '家博会-展前联系',
sum(case 一次电话判定 when '不打' then 1 end) as  '不打',
sum(case 一次电话判定 when '三天未通' then 1 end) as  '三天未通',
sum(case 一次电话判定 when '未通' then 1 end) as  '未通',
sum(case 一次电话判定 when '未打' then 1 end) as  '未打',

CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '婚博会-来' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票'
) then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '婚博会-来率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '婚博会-不确定' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '婚博会-不确定率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '婚博会-判断不清' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '婚博会-判断不清率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '婚博会-扫码入场' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '婚博会-扫码入场率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '婚博会-已经有票' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '婚博会-已经有票率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '珠宝展-来' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '珠宝展-来率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '珠宝展-不确定' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '珠宝展-不确定率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '珠宝展-现场取' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '珠宝展-现场取率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '珠宝展-判断不清' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '珠宝展-判断不清率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '旅游展-来' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '旅游展-来率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '旅游展-不确定' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '旅游展-不确定率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '旅游展-现场取' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '旅游展-现场取率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '旅游展-判断不清' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '旅游展-判断不清率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '家博会-来' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '家博会-来率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '家博会-不确定' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '家博会-不确定率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '家博会-判断不清' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '家博会-判断不清率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '家博会-现场取' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '家博会-现场取率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '家博会-扫码入场' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '家博会-扫码入场率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '快递前确认地址' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '快递前确认地址率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '双空错号' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '双空错号率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '不来' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '不来率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '下届联系' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '下届联系率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '下届无效' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '下届无效率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '暂无需求' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '暂无需求率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '筹备完毕' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '筹备完毕率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '勿扰' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '勿扰率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '小蜜蜂专业' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '小蜜蜂专业率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '重复数据' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '重复数据率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '删除数据' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '删除数据率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '异地索票' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票') then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '异地索票率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '展前联系' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 is not null then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '展前联系率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '家博会-展前联系' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 is not null then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '家博会-展前联系率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '不打' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 is not null then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '不打率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '三天未通' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 in('婚博会-来','婚博会-不确定','婚博会-判断不清','婚博会-扫码入场','婚博会-已经有票','珠宝展-来','珠宝展-不确定','珠宝展-现场取','珠宝展-判断不清','旅游展-来','旅游展-不确定','旅游展-现场取','旅游展-判断不清','家博会-来','家博会-不确定','家博会-判断不清','家博会-现场取','家博会-扫码入场','快递前确认地址','双空错号','不来','下届联系','下届无效','暂无需求','筹备完毕','勿扰','小蜜蜂专业','重复数据','删除数据','异地索票','三天未通'
) then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '三天未通率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '未通' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 is not null then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '未通率',
CAST(CONVERT( DECIMAL(18,2),sum(case 一次电话判定 when '未打' then 1 end)/CAST(ISNULL(NULLIF(sum(case  when 一次电话判定 is not null then 1 end),0),1) AS FLOAT)*100)AS VARCHAR(10))+'%' AS '未打率'
from sheet1 
group by  一次电话分配日期,一次电话内容,一次电话负责人"""
#cursor.execute(query)
print ("电话统计结果生成中,请稍等")
#搜取所有结果
#results = cursor.fetchall()
# 获取MYSQL里面的数据字段名称
#fields = cursor.description
df = pd.read_sql(query,database)
#df['打通率'].apply(lambda x: x.replace('%', '')).astype('float') / 100
#cursor.close()
df1=df[df['一次电话内容'].str.contains('家博会-')]
df2=df[~df['一次电话内容'].str.contains('家博会-')]
print(df)
#print(df1)
#print(df2)

df.to_excel(r'E:\\电话统计\\一遍\\结果\\'+time.strftime("%Y-%m-%d") +'-婚博会+家博会.xlsx', sheet_name='bigdata')
df1.to_excel(r'E:\\电话统计\\一遍\\结果\\'+time.strftime("%Y-%m-%d") +'-家博会.xlsx', sheet_name='家')
df2.to_excel(r'E:\\电话统计\\一遍\\结果\\'+time.strftime("%Y-%m-%d") +'-婚博会.xlsx', sheet_name='婚')
#df1.to_excel(r'E:\\电话统计\\一遍\\结果\\家博会.xlsx', sheet_name='data')
#df2.to_excel(r'E:\\电话统计\\一遍\\结果\\婚博会.xlsx', sheet_name='data')
# 关闭游标
# 提交
database.commit()
# 关闭数据库连接
database.close()
print ("电话统计结果生成完毕,请查看E盘、电话统计、一遍、结果")
#print (time.strftime('%Y-%m-%d %H:%M:%S',time.localtime(time.time())),"mysqlData to excel Finished!")
end_time = datetime.datetime.now()
print(u'程序运行了' + str((end_time - start_time).seconds) + u'秒!')
# 打印结果
time.sleep(10)
